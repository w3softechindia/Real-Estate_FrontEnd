<app-agencytopbar></app-agencytopbar>

<div class="page-layout">
  <app-agencyssidebar></app-agencyssidebar>

  <div class="main-content">
    <div class="list-header">
      <h2>Sales Overview (Token Paid Customers)</h2>
    </div>

    <!-- Search -->
    <div class="search-box">
      <input type="text" [(ngModel)]="searchAgent" placeholder="Search by Agent" />
      <input type="text" [(ngModel)]="searchCustomer" placeholder="Search by Customer" />
      <input type="date" [(ngModel)]="searchDate" />
    </div>

    <!-- Table -->
    <div class="table-view">
      <table>
        <thead>
          <tr>
            <th>Property</th>
            <th>Agent</th>
            <th>Customer</th>
            <th>Token Amount</th>
            <!-- <th>Balance Amount</th> -->
            <th>Total Price</th>
            <th>Status</th>
            <th>Booking</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let token of filteredSalesTokens">
            <td>{{ token.tokenid }}</td>
            <td>{{ token.agentName }}</td>
            <td>{{ token.lead.leadName }}</td>
            <td>{{ token.amount| currency }}</td>
            <!-- <td>{{ token.balanceAmount | currency }}</td> -->
            <td>{{ token.finalAmount| currency }}</td>
            <td>
              <span [ngClass]="{
                'status-paid': token.finalStatus === 'paid',
                'status-pending': token.finalStatus === 'pending',
                'status-rejected': token.finalStatus === 'rejected',
                'status-sold': token.finalStatus === 'sold'
              }">
                {{ token.finalStatus | titlecase }}
              </span>
            </td>
            <td>{{ token.tokenDeadLine| date: 'mediumDate' }}</td>
            <td>
              <button *ngIf="token.finalStatus === 'pending'" class="balance-btn" (click)="openAcceptBalance(token)">
                Accept Balance
              </button>
              <ng-container *ngIf="token.finalStatus === 'paid'">
                <button class="view-btn" (click)="viewToken(token)">Details</button>
                <button class="followup-btn" (click)="openFollowUp(token)">Follow Up</button>
              </ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Accept Balance Modal -->
    <!-- <div class="modal-overlay" *ngIf="balanceToken">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Confirm Balance Payment</h3>
          <button class="close-btn" (click)="closeBalanceModal()">✕</button>
        </div>
        <div class="modal-body">
          <p><strong>Customer:</strong> {{ balanceToken.lead.leadName }}</p>
          <p><strong>Property:</strong> {{ balanceToken.propertyName }}</p>
          <p><strong>Total Price:</strong> {{ balanceToken.totalPrice | currency }}</p>
          <p><strong>Token Paid:</strong> {{ balanceToken.tokenAmount | currency }}</p>
          <p><strong>Balance Amount:</strong> {{ balanceToken.balanceAmount | currency }}</p>

          <p [class.bad]="!isBackendBalanceMatch">
            <strong>Backend Balance Check:</strong>
            {{ isBackendBalanceMatch ? '✔ Matches calculation' : '✖ Does not match' }}
          </p>

          <p [class.bad]="!isTotalCorrect">
            <strong>Total Price Check:</strong>
            {{ isTotalCorrect ? '✔ token + balance = total' : '✖ Mismatch' }}
          </p>

          <div class="modal-actions">
            <button class="save-btn" [disabled]="!canConfirmBalance()" (click)="acceptBalance()">
              Confirm Payment
            </button>
            <button class="cancel-btn" (click)="closeBalanceModal()">Cancel</button>
          </div>

          <p *ngIf="balanceConfirmMessage" class="success">{{ balanceConfirmMessage }}</p>
        </div>
      </div>
    </div> -->

<!-- Accept Balance Modal -->
<div class="modal-overlay" *ngIf="balanceToken">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Confirm Balance Payment</h3>
      <button class="close-btn" (click)="closeBalanceModal()">✕</button>
    </div>

    <div class="modal-body">
      <p><strong>Customer:</strong> {{ balanceToken.lead.leadName }}</p>
      <p><strong>Agent:</strong> {{ balanceToken.agentName }}</p>
      <p><strong>Total Price:</strong> {{ balanceToken.finalAmount | currency }}</p>
      <p><strong>Token Paid:</strong> {{ balanceToken.amount | currency }}</p>
      <p><strong>Balance Amount (calculated):</strong> {{ calculatedBalance | currency }}</p>

      <p [class.bad]="!isBackendBalanceMatch">
        <strong>Backend Balance Check:</strong>
        {{ isBackendBalanceMatch ? '✔ Matches calculation' : '✖ Does not match' }}
      </p>

      <p [class.bad]="!isTotalCorrect">
        <strong>Total Price Check:</strong>
        {{ isTotalCorrect ? '✔ Token + Balance = Total' : '✖ Mismatch' }}
      </p>

      <div class="modal-actions">
        <button class="save-btn" [disabled]="!canConfirmBalance()" (click)="acceptBalance()">
          Confirm Payment
        </button>
        <button class="cancel-btn" (click)="closeBalanceModal()">Cancel</button>
      </div>

      <p *ngIf="balanceConfirmMessage" class="success">
        {{ balanceConfirmMessage }}
      </p>
    </div>
  </div>
</div>




    <!-- Follow Up Modal -->
    <div class="modal-overlay" *ngIf="followUpToken">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Follow Up: {{ followUpToken.lead.leadName }}</h3>
          <button class="close-btn" (click)="closeFollowUp()">✕</button>
        </div>
        <div class="modal-body">
          <p><strong>Property:</strong> {{ followUpToken.venture.ventureName }}</p>
          <p><strong>Total Price:</strong> {{ followUpToken.venture.price | currency }}</p>
          <p><strong>Status:</strong> {{ followUpToken.token.agencyStatus | titlecase }}</p>

          <!-- <label>Remarks</label>
          <textarea [(ngModel)]="followUpRemarks" placeholder="Enter remarks here"></textarea> -->

          <div class="action-buttons">
            <button class="mark-sold-btn" (click)="markAsSold()">Mark as Sold</button>
            <button class="reject-btn" (click)="cancelToken()">Cancel Token</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Details Modal -->
    <div class="modal-overlay" *ngIf="selectedToken">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Sales Token Details</h3>
          <button class="close-btn" (click)="closeModal()">✕</button>
        </div>
        <div class="modal-body">
          <p><strong>Property:</strong> {{ selectedToken.venture.ventureName }}</p>
          <p><strong>Agent:</strong> {{ selectedToken.lead.agentName }}</p>
          <p><strong>Customer:</strong> {{ selectedToken.lead.leadName }}</p>
          <p><strong>Total Price:</strong> {{ selectedToken.venture.price | currency }}</p>
          <p><strong>Token Amount:</strong> {{ selectedToken.token.amount| currency }}</p>
          <p><strong>Balance Amount:</strong> {{ selectedToken.balanceAmount | currency }}</p>
          <p><strong>Booking Date:</strong> {{ selectedToken.bookingDate | date: 'fullDate' }}</p>
          <p><strong>Status:</strong> {{ selectedToken.token.agencyStatus | titlecase }}</p>
          <p><strong>Remarks:</strong> {{ selectedToken.futureScope || 'No remarks yet' }}</p>
        </div>
      </div>
    </div>
  </div>
</div>